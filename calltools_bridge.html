<!DOCTYPE html>
<html>
<head>
    <title>CallTools + HumeAI Bridge</title>
    <style>
        body { 
            font-family: Arial; 
            padding: 20px; 
            background: #1a1a1a;
            color: #fff;
        }
        .status { 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
            font-weight: bold;
        }
        .connected { background: #0f5132; }
        .disconnected { background: #842029; }
        .log { 
            background: #2d2d2d; 
            padding: 10px; 
            margin: 10px 0; 
            height: 400px; 
            overflow-y: scroll;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            padding: 5px;
            border-bottom: 1px solid #3d3d3d;
        }
        .log-success { color: #0f5; }
        .log-error { color: #f55; }
        .log-info { color: #5af; }
        button {
            background: #0d6efd;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover { background: #0b5ed7; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
    </style>
</head>
<body>
    <h1>üéØ CallTools + HumeAI Voice Bridge</h1>
    
    <div id="status" class="status disconnected">
        ‚è∏Ô∏è Not Connected
    </div>
    
    <div>
        <button id="startBtn" onclick="startSystem()">‚ñ∂Ô∏è Start System</button>
        <button id="stopBtn" onclick="stopSystem()" disabled>‚èπÔ∏è Stop System</button>
        <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
    </div>
    
    <div class="log" id="log"></div>
    
    <script>
        // Configuration
        const BACKEND_URL = 'ws://localhost:8000/ws/webrtc-audio';
        
        let ws = null;
        let audioContext = null;
        let microphone = null;
        let processor = null;
        let isRunning = false;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(message, connected) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = connected ? 'status connected' : 'status disconnected';
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        async function startSystem() {
            if (isRunning) return;
            
            try {
                log('üöÄ Starting CallTools + HumeAI Bridge...', 'info');
                
                // Disable start button
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                
                // Connect to backend WebSocket
                log('üì° Connecting to backend...', 'info');
                ws = new WebSocket(BACKEND_URL);
                
                ws.onopen = async () => {
                    log('‚úÖ Backend connected!', 'success');
                    updateStatus('‚úÖ Connected to Backend', true);
                    
                    // Get microphone access
                    log('üé§ Requesting microphone access...', 'info');
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ 
                            audio: {
                                echoCancellation: true,
                                noiseSuppression: true,
                                autoGainControl: true,
                                sampleRate: 16000
                            } 
                        });
                        
                        log('‚úÖ Microphone access granted', 'success');
                        
                        // Setup audio processing
                        audioContext = new (window.AudioContext || window.webkitAudioContext)({
                            sampleRate: 16000
                        });
                        
                        microphone = audioContext.createMediaStreamSource(stream);
                        processor = audioContext.createScriptProcessor(4096, 1, 1);
                        
                        processor.onaudioprocess = (e) => {
                            if (!ws || ws.readyState !== WebSocket.OPEN) return;
                            
                            const inputData = e.inputBuffer.getChannelData(0);
                            
                            // Convert Float32Array to Int16Array
                            const int16Data = new Int16Array(inputData.length);
                            for (let i = 0; i < inputData.length; i++) {
                                int16Data[i] = Math.max(-32768, Math.min(32767, inputData[i] * 32768));
                            }
                            
                            // Convert to base64
                            const base64Audio = btoa(String.fromCharCode(...new Uint8Array(int16Data.buffer)));
                            
                            // Send to backend
                            ws.send(JSON.stringify({
                                type: 'audio',
                                data: base64Audio
                            }));
                        };
                        
                        microphone.connect(processor);
                        processor.connect(audioContext.destination);
                        
                        log('üéôÔ∏è Audio streaming started', 'success');
                        updateStatus('‚úÖ Active - Audio Streaming', true);
                        isRunning = true;
                        
                    } catch (err) {
                        log(`‚ùå Microphone error: ${err.message}`, 'error');
                        updateStatus('‚ùå Microphone Error', false);
                    }
                };
                
                ws.onmessage = async (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        
                        switch(data.type) {
                            case 'hume_connected':
                                log('ü§ñ HumeAI connected!', 'success');
                                break;
                            
                            case 'ai_audio':
                                // AI response audio
                                log('üîä Received AI audio', 'info');
                                playAIAudio(data.audio);
                                break;
                            
                            case 'ai_transcript':
                                log(`ü§ñ AI: ${data.text}`, 'info');
                                break;
                            
                            case 'user_transcript':
                                log(`üë§ You: ${data.text}`, 'info');
                                break;
                            
                            case 'call_start':
                                log('üìû Call started!', 'success');
                                break;
                            
                            case 'call_end':
                                log('üìû Call ended', 'info');
                                break;
                            
                            case 'error':
                                log(`‚ùå Error: ${data.message}`, 'error');
                                break;
                            
                            default:
                                log(`üì® ${data.type}`, 'info');
                        }
                    } catch (err) {
                        log(`‚ùå Message parse error: ${err.message}`, 'error');
                    }
                };
                
                ws.onerror = (error) => {
                    log('‚ùå WebSocket error', 'error');
                    updateStatus('‚ùå Connection Error', false);
                };
                
                ws.onclose = () => {
                    log('üì° Disconnected from backend', 'info');
                    updateStatus('‚è∏Ô∏è Disconnected', false);
                    stopSystem();
                };
                
            } catch (error) {
                log(`‚ùå Startup error: ${error.message}`, 'error');
                updateStatus('‚ùå Error', false);
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
            }
        }
        
        function playAIAudio(base64Audio) {
            try {
                // Decode base64
                const binaryString = atob(base64Audio);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                // Convert to Float32
                const float32Array = new Float32Array(bytes.length / 2);
                const dataView = new DataView(bytes.buffer);
                for (let i = 0; i < float32Array.length; i++) {
                    float32Array[i] = dataView.getInt16(i * 2, true) / 32768.0;
                }
                
                // Create audio buffer
                const audioBuffer = audioContext.createBuffer(1, float32Array.length, 16000);
                audioBuffer.getChannelData(0).set(float32Array);
                
                // Play
                const source = audioContext.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(audioContext.destination);
                source.start();
                
                log('‚ñ∂Ô∏è Playing AI response', 'success');
            } catch (err) {
                log(`‚ùå Audio playback error: ${err.message}`, 'error');
            }
        }
        
        function stopSystem() {
            log('‚èπÔ∏è Stopping system...', 'info');
            
            isRunning = false;
            
            // Stop audio processing
            if (processor) {
                processor.disconnect();
                processor = null;
            }
            
            if (microphone) {
                microphone.disconnect();
                microphone = null;
            }
            
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            // Close WebSocket
            if (ws) {
                ws.close();
                ws = null;
            }
            
            log('‚úÖ System stopped', 'info');
            updateStatus('‚è∏Ô∏è Stopped', false);
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }
        
        // Auto-start on page load (optional)
        // window.addEventListener('load', () => {
        //     setTimeout(startSystem, 1000);
        // });
    </script>
</body>
</html>
