(window.webpackJsonp=window.webpackJsonp||[]).push([[10],{"5Tly":function(e,t,i){"use strict";i.d(t,"a",(function(){return c}));var n=i("N/25"),s=i("zBIn"),a=i("fXoL");let c=(()=>{class e{constructor(e,t){this._authService=e,this._userService=t,this.usersMap=[],this.usersMapNoDashes=[],this.users=[]}getUser(){this._userService.get(this._authService.getUserId()).subscribe({next:e=>{this.user=e}})}getUserById(e){return this._userService.get(e)}getUsers(){this._userService.listMinimizedUsers().subscribe({next:e=>{this.users=e,e.forEach(e=>{this.usersMap[e.app_user]=e,this.usersMapNoDashes[e.app_user.replace(/-/g,"")]=e})}})}}return e.\u0275fac=function(t){return new(t||e)(a.nc(n.a),a.nc(s.a))},e.\u0275prov=a.Xb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})()},"8nRA":function(e,t,i){"use strict";i.d(t,"a",(function(){return L}));var n=i("XNiG"),s=i("PqYM"),a=i("/6jY"),c=i("w0BY"),o=i("d0VH"),r=i("qqew"),u=i("gFx0"),l=i("SqhC"),h=i("IbGr"),d=i("N/25"),g=i("rryV"),p=i("M4Aq"),S=i("fkGI"),v=i("+3se"),m="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto),_=new Uint8Array(16);function b(){if(!m)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return m(_)}for(var f=[],C=0;C<256;++C)f[C]=(C+256).toString(16).substr(1);var w=function(e,t,i){var n=t&&i||0;"string"==typeof e&&(t="binary"===e?new Array(16):null,e=null);var s=(e=e||{}).random||(e.rng||b)();if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,t)for(var a=0;a<16;++a)t[n+a]=s[a];return t||function(e,t){var i=0;return[f[e[i++]],f[e[i++]],f[e[i++]],f[e[i++]],"-",f[e[i++]],f[e[i++]],"-",f[e[i++]],f[e[i++]],"-",f[e[i++]],f[e[i++]],"-",f[e[i++]],f[e[i++]],f[e[i++]],f[e[i++]],f[e[i++]],f[e[i++]]].join("")}(s)},I=i("beuU"),y=i("NkwR"),N=i("Q0oM"),A=i("Z181"),P=i("LVKg"),T=i("as3Y"),k=i("fXoL"),D=i("tk/3");let j=(()=>{class e{constructor(e){this.http=e}get(e){return this.http.get(`/api/phonenumberdnccheck/${e}/`,{observe:"response"})}}return e.\u0275fac=function(t){return new(t||e)(k.nc(D.b))},e.\u0275prov=k.Xb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})();var x=i("xyEW"),q=i("CZaT"),O=i("5Tly"),B=i("fFgH"),U=i("dNgK"),X=i("0IaG");let L=(()=>{class e{constructor(e,t,i,s,a,c,o,r,u,l,h,d,g,p,S,v,m,_,b,f,C,w,I,y){this._utils=e,this._snackBar=t,this._dialog=i,this._webPhoneService=s,this._webPhoneWindowService=a,this._agentContactService=c,this._agentCampaignService=o,this._agentPostCallService=r,this._agentStatusService=u,this._agentQueueService=l,this._authService=h,this._callerIdService=d,this._agentStoredContactService=g,this._agentAccountSettingService=p,this._agentAgentScriptService=S,this._contactSearchService=v,this._agentNavService=m,this._userPreferenceService=_,this._myRecentCallsService=b,this._campaignContactService=f,this._phoneNumberDncCheckService=C,this._agentHotLeadService=w,this._webPhoneOverlayService=I,this._agentUserService=y,this.activeSession=null,this.dtmfAudio=new Audio,this.ringtone=new Audio,this.sitTone=new Audio,this.callConnectedAudio=new Audio,this.callDisconnectedAudio=new Audio,this.phoneNumberInput="",this.transferring=!1,this.gettingLastCall=!1,this.backgroundCssFlashSubject=new n.a,this.callVariables=[],this.ringtoneDelay=5500,this.ringtoneLoopCount=0,this.showDialBtnSpinner=!1,this.registered=!1,this.activeSession=null,this.incomingSession=null,this.onHold=[],this._webPhoneService.phoneEvents.subscribe(e=>{this.handlePhoneEvent(e)}),this._agentAccountSettingService.accountSettingsSubject.subscribe({next:e=>{this.accountSettings=e,this.defaultReadyStatus=e.ready_status,this.defaultOnCallStatus=e.on_call_status,this.defaultPostCallStatus=e.post_call_status}})}answer(){this.incomingSession&&(this.activeSession&&this.hold(this.activeSession),this._webPhoneService.answer(this.incomingSession),this.activeSession=this.incomingSession,this.incomingSession=null)}call(e,t){if(!(e=this._utils.sanitizePhoneNumber(e))&&this._agentContactService.selectedPhoneNumber&&(e=this._agentContactService.selectedPhoneNumber.phone_number),!e)return;let i=this._utils.numberBelongsToContact(this._agentContactService.contactSubject.value,e);if(this.activeSession){if(this.activeSession.data.phoneNumber===e)return;this.hold(this.activeSession)}this.callUuid=this._generateUUID();let n=t||(i?i.contact:null);if(e.length>4){let t=this._agentStatusService.agentStatusSubject.value?this._agentStatusService.agentStatusSubject.value.campaign:null,s=null;i&&t&&this._agentContactService.campaignContactSubject.value&&i.contact===this._agentContactService.campaignContactSubject.value.id&&(s=t),this._callerIdService.getByDestination(e,n,s||null).subscribe({next:t=>{var i;if(!t.results.length)return void this._snackBar.open("No Caller ID Available","X",{duration:2500,verticalPosition:"top",panelClass:"error"});const a=t.results[0],c=["Src: "+a.phone_number,"x_cnam: "+a.cnam,"x_caller_id: "+a.phone_number,"x_caller_id_id: "+a.id,"x_call_uuid: "+this.callUuid,"x_c_sti: "+(a.sti_verified?"True":"False")];if(s){const e=this._agentContactService.campaignContactSubject.value;if(e){const{_bucket_id:t,_live_filter_id:i}=e;t?c.push("x_bucket_id: "+t):i&&c.push("x_live_filter_id: "+i)}c.push("x_campaign_id: "+s);const t=this._agentCampaignService.campaignMap[s];t&&((null===(i=this.accountSettings)||void 0===i?void 0:i.temp_force_recording)?c.push("x_call_recording: True"):c.push("x_call_recording: "+(t.call_recording?"True":"False")))}const o=this._agentCampaignService.allCampaigns.find(e=>e.id===s);n?(c.push("x_contact_id: "+n),this._checkPhoneNumberDncStatus(e,{phoneNumber:e,callHeaders:c,userCampaignId:s,contact:n,callerId:a,campaign:o})):this._contactSearchService.searchByPhoneNumber(1,1,e).subscribe({next:t=>{t&&t.results.length?(n=t.results[0]?t.results[0].id:null,n&&c.push("x_contact_id: "+n),this._checkPhoneNumberDncStatus(e,{phoneNumber:e,callHeaders:c,userCampaignId:s,contact:n||null,callerId:a,campaign:o}),n&&(this._agentContactService.getContact(n),this._agentNavService.activeTopSectionSubject.next("dashboard"))):(this._agentContactService.createEmptyContact(e),this._checkPhoneNumberDncStatus(e,{phoneNumber:e,callHeaders:c,userCampaignId:s,contact:null,callerId:a,campaign:o}))},error:()=>{this._agentContactService.createEmptyContact(e),this._checkPhoneNumberDncStatus(e,{phoneNumber:e,callHeaders:c,userCampaignId:s,contact:null,callerId:a,campaign:o})}})},error:e=>{this._snackBar.open(this._utils.handleErrorResponse(e,"Error Retrieving Caller ID"),"X",{duration:3e4,verticalPosition:"top",panelClass:["error"]})}})}else this._setAgentStatusToOnCall({campaign:null,contact:n||null}),this.activeSession=this._webPhoneService.call(e,["x_contact_id: "+(n||""),"x_call_uuid: "+this.callUuid])}_checkPhoneNumberDncStatus(e,t){this.showDialBtnSpinner=!0,this._phoneNumberDncCheckService.get(e).subscribe({next:e=>{202===e.status?this._dialog.open(N.a,{width:"500px",data:{title:e.body&&e.body.message?e.body.message:"This number is on the federal dnc, would you like to call?",buttonText:"Call"}}).afterClosed().subscribe({next:e=>{e&&this._launchCall(t),this.showDialBtnSpinner=!1}}):(this._launchCall(t),this.showDialBtnSpinner=!1)},error:e=>{this.showDialBtnSpinner=!1,this._snackBar.open(this._utils.handleErrorResponse(e,"Error Getting Phone Number DNC Status"),"X",{duration:7500,verticalPosition:"top",panelClass:"error"})}})}_launchCall(e){this._setAgentStatusToOnCall({campaign:e&&e.campaign?e.campaign:null,contact:e&&e.contact?e.contact:null}),this._campaignContactService.lastCampaignContact&&e.contact&&this._campaignContactService.lastCampaignContact.id===e.contact&&(this._campaignContactService.lastCampaignContact.called=!0),this.activeSession=this._webPhoneService.call(e.phoneNumber,e.callHeaders),this.activeSession&&(this.activeSession.data.callUuid=this.callUuid,this.activeSession.data.readyStatusId=e.campaign&&e.campaign.ready_status?e.campaign.ready_status:this.defaultReadyStatus,this.activeSession.data.phoneNumber=e.phoneNumber,this.activeSession.data.contactId=e.contact?e.contact:null,this.activeSession.data.sourceNumber=e.callerId.phone_number,this.activeSession.data.campaignId=e.userCampaignId,this.activeSession.data.liveFilter=e.campaign&&e.campaign.live_filter?e.campaign.live_filter:null,this.activeSession.data.bucketId=e.campaign&&e.campaign.bucket?e.campaign.bucket:null)}isPhoneNumber(e){return/^\+?1?[.\s\-]?\(?[2-9]{1}[0-9]{2}\)?[.\s\-]?[0-9]{3}[.\s\-]?[0-9]{4}$/.test(e)}sendDTMF(e,t){this._webPhoneService.sendDTMF(e,t||this.activeSession)}playDTMF(e){this.dtmfAudio=new Audio,"#"===e?e="hash":"*"===e&&(e="star"),this.dtmfAudio.src="/assets/audio/phone/"+e+".wav",this.dtmfAudio.crossOrigin="anonymous",this.dtmfAudio.load(),this.dtmfAudio.play().catch(e=>{console.log(e)})}hold(e){this._webPhoneService.hold(e)}unHold(e){this._webPhoneService.unhold(e)}hangUp(e){e&&!e._is_canceled&&8!==e._status&&(e._is_canceled=!0,this._webPhoneService.hangUp(e))}stopIncomingCallRingtone(){this.ringtone&&(this.ringtone.pause(),this.ringtone=null),this.ringtoneLoopCount=0,clearTimeout(this.ringtoneTimeout)}playSitTone(){this.sitTone=new Audio,this.sitTone.src="/assets/audio/phone/sit.wav",this.sitTone.load(),this.sitTone.crossOrigin="anonymous",this.sitTone.play().catch(e=>{})}playIncomingCallTone(){this.ringtone=new Audio,this.ringtone.src="/assets/audio/phone/incoming-call.wav",this.ringtone.load(),this._userPreferenceService.userPreferenceSubject.value&&(this.ringtone.volume=this._userPreferenceService.userPreferenceSubject.value.agent_ringtone_volume),this.ringtone.crossOrigin="anonymous",this.ringtone.play().catch(e=>{console.log(e)})}playRingtone(){this.ringtone=new Audio,this.ringtone.src="/assets/audio/phone/ringtone.wav",this.ringtone.load(),this._userPreferenceService.userPreferenceSubject.value&&(this.ringtone.volume=this._userPreferenceService.userPreferenceSubject.value.agent_ringtone_volume),this.ringtone.crossOrigin="anonymous",this.ringtone.play().catch(e=>{console.log(e)}),clearTimeout(this.ringtoneTimeout),this.ringtoneTimeout=setTimeout(()=>{this.ringtoneLoopCount>9?this.stopIncomingCallRingtone():(this.ringtoneLoopCount++,this.ringtone=null,this.playRingtone())},this.ringtoneDelay)}recordVoiceMailGreeting(e){this.activeSession=this._webPhoneService.call("*90",["x_voice_mail_id: "+e])}redial(){this.gettingLastCall=!0,this._myRecentCallsService.getLastCall().subscribe({next:e=>{const t=e.results[0];t&&this.call(t.inbound?t.source:t.destination),this.gettingLastCall=!1},error:()=>{this.gettingLastCall=!1}})}reject(){this.incomingSession&&(this._webPhoneService.reject(this.incomingSession),this.incomingSession=null,this._webPhoneWindowService.changeSelectedWindow(this.activeSession?"current-call":"dial-pad"))}toggleMute(e){e&&(e._audioMuted?this._webPhoneService.unmute(e):this._webPhoneService.mute(e))}_setAgentStatusToOnCall(e){this._agentStatusService.updateAgentStatus({web_phone_status:"On Call",agent_status:e&&e.campaign?e.campaign.on_call_status:this.defaultOnCallStatus,current_contact:e&&e.contact?e.contact:null})}_generateUUID(){return w().replace(/-/g,"")}formatTimer(e){let t=new Date(null);return t.setSeconds(e),t.toISOString().substr(11,8)}handlePhoneEvent(e){var t,i,n,s,a;const c=e.session?e.session._request.headers:null,o=c&&c["X-Auto-Answer"]?c["X-Auto-Answer"][0].raw:null,r=c&&c["X-Contact-Id"]?parseInt(c["X-Contact-Id"][0].raw):null,u=c&&c["X-Destination"]?c["X-Destination"][0].raw:null,l=c&&c["X-Source"]?c["X-Source"][0].raw:null,h=c&&c["X-Campaign-Id"]?parseInt(c["X-Campaign-Id"][0].raw):null,d=c&&c["X-Queue-Id"]?parseInt(c["X-Queue-Id"][0].raw):null,g=c&&c["X-Ready-Status-Id"]?parseInt(c["X-Ready-Status-Id"][0].raw):this.defaultReadyStatus,p=c&&c["X-On-Call-Status-Id"]?parseInt(c["X-On-Call-Status-Id"][0].raw):this.defaultOnCallStatus,S=c&&c["X-Post-Call-Status-Id"]?parseInt(c["X-Post-Call-Status-Id"][0].raw):this.defaultPostCallStatus,v=c&&c["X-Call-Uuid"]?c["X-Call-Uuid"][0].raw:null,m=c&&c["X-Live-Filter-Id"]?parseInt(c["X-Live-Filter-Id"][0].raw):null,_=c&&c["X-Bucket-Id"]?parseInt(c["X-Bucket-Id"][0].raw):null,b=c&&c["X-Inbound-Route-Id"]?parseInt(c["X-Inbound-Route-Id"][0].raw):null,f=c&&c["X-Did"]?c["X-Did"][0].raw:null,C=c&&c["X-Inbound-Route-Name"]?c["X-Inbound-Route-Name"][0].raw:null,w=c&&c["X-Contact-First-Name"]?c["X-Contact-First-Name"][0].raw:null,I=c&&c["X-Contact-Last-Name"]?c["X-Contact-Last-Name"][0].raw:null,y=c&&c["X-Hot-Lead-Bucket-Id"]?parseInt(c["X-Hot-Lead-Bucket-Id"][0].raw):null,N=c&&c["X-Hot-Lead-Bucket-Name"]?c["X-Hot-Lead-Bucket-Name"][0].raw:"",A=c&&c["X-Transferred-By-Agent"]?c["X-Transferred-By-Agent"][0].raw:null;this.callVariables=[],r?this.callVariables[r]={contact:r,queue:d,campaign:h,inbound_route:b,live_filter:m,bucket:_}:this.callVariables.newContact={contact:r,queue:d,campaign:h,inbound_route:b,live_filter:m,bucket:_};const P=e.session?"dial"===e.session.remote_identity.uri.user?u:e.session.remote_identity.uri.user:null;switch(e.type){case"newRTCSession.inbound":if(this._webPhoneOverlayService.showOverlay&&(this._webPhoneOverlayService.showOverlay=!1),this.activeSession)this.activeSession&&(this.isPhoneNumber(P)&&(e.session.data.phoneNumber=P),this._webPhoneWindowService.changeSelectedWindow("incoming-call"),this.playIncomingCallTone());else{if("true"===o){this._webPhoneService.answer(e.session),this.isPhoneNumber(P)&&(e.session.data.phoneNumber=P),this.previousCall=e.session,this.previousActiveNumber=P,this._playCallConnectedTone(),this.backgroundCssFlashSubject.next(!0),(w||I)&&(this._agentContactService.contactSubject.next(null),this._agentContactService.contactSubject.next({first_name:w,last_name:I,tags:[]})),this.activeSession=e.session,this.activeSession.data.sourceNumber=l,this.activeSession.data.phoneNumber=u||P,this.activeSession.data.queueId=d||null,this.activeSession.data.liveFilter=m||null,this.activeSession.data.bucketId=_||null,this.activeSession.data.callStartTime=(new Date).getTime(),r?(y&&(this._agentHotLeadService.hotBucketLeads.find(e=>e.contactId===r)||this._agentHotLeadService.hotBucketLeads.push({contactId:r,hotLeadBucketId:y,hotLeadBucketName:N})),this._agentContactService.getContact(r)):(this._agentContactService.contactSubject.next(null),this._agentContactService.createEmptyContact(e.session.data.phoneNumber?e.session.data.phoneNumber:null));break}if(this.isPhoneNumber(P)&&(e.session.data.phoneNumber=P),d&&(e.session.data.queueCall=!0,e.session.data.queueId=d),b&&(e.session.data.inboundRoute=b,e.session.data.inboundRouteDID=f,e.session.data.inboundRouteName=C),this.previousCall=e.session,this.previousActiveNumber=P,this._agentContactService.contactSubject.value&&this._agentContactService.contactSubject.value.id!==r){const e=Object.assign({},this._agentContactService.contactSubject.value);this._agentStoredContactService.storeContact(e)}r?(y&&(this._agentHotLeadService.hotBucketLeads.find(e=>e.contactId===r)||this._agentHotLeadService.hotBucketLeads.push({contactId:r,hotLeadBucketId:y,hotLeadBucketName:N})),this._agentContactService.getContact(r)):(this._agentContactService.contactSubject.next(null),this._agentContactService.createEmptyContact(e.session.data.phoneNumber&&"anonymous"!==e.session.data.phoneNumber&&"Restricted"!==e.session.data.phoneNumber?e.session.data.phoneNumber:null)),this._webPhoneWindowService.changeSelectedWindow("incoming-call"),this.playRingtone()}this.incomingSession=e.session;break;case"accepted":this.activeSession&&"incoming"===this.activeSession.direction&&this._webPhoneWindowService.changeSelectedWindow("current-call"),this.stopIncomingCallRingtone();break;case"confirmed":{this.startSessionTimer(e.session),this.stopIncomingCallRingtone(),this.phoneNumberInput=u||P;const i=h||(e.session.data.campaignId?e.session.data.campaignId:null),n=i?this._agentCampaignService.campaignsShownOnTable.find(e=>e.id===i):null;if("incoming"===(null===(t=e.session)||void 0===t?void 0:t.direction)&&(this._agentStatusService.updateAgentStatus({web_phone_status:"On Call",agent_status:n?n.on_call_status:p,current_contact:r||e.session.data.contactId}),(r||e.session.data.contactId)&&this._agentContactService.getContact(r||e.session.data.contactId)),!this.activeSession)return;if(A){const e=this._agentUserService.usersMapNoDashes[A];e?this.activeSession.data.transferredByAgent=e:this._agentUserService.getUserById(A).subscribe({next:e=>{this.activeSession.data.transferredByAgent=e,this._agentUserService.usersMapNoDashes[A]=e,this._agentUserService.usersMap[e.app_user]=e}})}if(this.activeSession.data.contactId=r||e.session.data.contactId,this.activeSession.data.callUuid=v||this.callUuid,this.activeSession.data.onCall=!0,this.activeSession.data.sourceNumber=l||e.session.data.sourceNumber,this.activeSession.data.phoneNumber=u||P,this.activeSession.data.inboundRoute=b||null,this.activeSession.data.inboundRouteDID=f||null,this.activeSession.data.inboundRouteName=C||null,this.activeSession.data.liveFilter=m||null,this.activeSession.data.bucketId=_||null,this.activeSession.data.readyStatusId=n?n.ready_status:g||null,this.activeSession.data.phoneNumber&&this._agentContactService.contactSubject.value&&this._agentContactService.contactSubject.value._phone_numbers&&this._agentContactService.contactSubject.value._phone_numbers.length){const e=this.activeSession.data.phoneNumber,t=this._agentContactService.contactSubject.value._phone_numbers.find(t=>t.phone_number===e);t&&(this._agentContactService.selectedPhoneNumber=t)}if(h){const e=this._agentCampaignService.campaignsShownOnTable.find(e=>e.id===h);e&&(this.activeSession.data.campaignCall=!0,this.activeSession.data.campaignId=e.id)}else if(d){const e=this._agentQueueService.queuesShownOnTable.find(e=>e.id===d);if(e&&(this.activeSession.data.queueCall=!0,this.activeSession.data.queueId=e.id,e.agent_script)){if(this._agentAgentScriptService.contactPersonalizationId&&this._agentAgentScriptService.contactPersonalizationId===r)return;this._agentAgentScriptService.agentScriptIdSubject.next(e.agent_script)}}else this._agentStatusService.agentStatusSubject.value&&this._agentStatusService.agentStatusSubject.value.campaign&&this._agentContactService.campaignContactSubject.value&&this._utils.numberBelongsToContact(this._agentContactService.campaignContactSubject.value,P)&&(this.activeSession.data.campaignCall=!0);this._showPostCallWrapUp(e,P,h,d);break}case"ended":{"remote"===e.originator&&this._playCallDisconnectedTone(),this.stopSessionTimer(e.session),this.phoneNumberInput="",this.activeSession&&(this.activeSession.data.onCall=!1);const t=h||(e.session.data.campaignId?e.session.data.campaignId:null),i=t?this._agentCampaignService.campaignsShownOnTable.find(e=>e.id===t):null;this._agentStatusService.updateAgentStatus({agent_status:i?i.post_call_status:S,web_phone_status:"Registered",current_contact:null}),this.transferring=!1,this.activeSession&&e.session.id==this.activeSession.id?(this.activeSession=null,this.onHold.length>0?this._webPhoneWindowService.changeSelectedWindow("active-calls"):this.incomingSession||this._webPhoneWindowService.changeSelectedWindow("dial-pad")):"incoming"===e.session.direction&&this.incomingSession&&this.incomingSession.id===e.session.id?this.incomingSession=null:(this.removeSessionOnHold(e.session),0!=this.onHold.length||this.activeSession||this._webPhoneWindowService.changeSelectedWindow("dial-pad"));break}case"hold":this.activeSession.id==e.session.id&&(this.activeSession=null),this.onHold.push(e.session),this.activeSession||this._webPhoneWindowService.changeSelectedWindow("active-calls");break;case"unhold":{this.activeSession&&this._webPhoneService.hold(this.activeSession),this.removeSessionOnHold(e.session),this.activeSession=e.session,this._webPhoneWindowService.changeSelectedWindow("current-call");const t=null===(i=this.activeSession)||void 0===i?void 0:i.data;this._setAgentStatusToOnCall({campaign:null!==(n=t.campaignId)&&void 0!==n?n:null,contact:null!==(s=t.contactId)&&void 0!==s?s:null});break}case"unregistered":this._authService.hasToken()&&!this._authService.currentlyLoggingOut&&this._agentStatusService.updateAgentStatus({web_phone_status:"Not Registered"}),this.registered=!1;break;case"registered":{this._webPhoneWindowService.changeSelectedWindow("dial-pad");const e=(new Date).toISOString();this._agentStatusService.updateAgentStatus({web_phone_status:"Registered",web_phone_registered_on:e}),this.registered=!0;break}case"registrationFailed":console.log("registration failed",e),this.registered=!1;break;case"failed":{this.stopIncomingCallRingtone(),this._playCallDisconnectedTone();const t=h||(e.session.data.campaignId?e.session.data.campaignId:null),i=t?this._agentCampaignService.campaignsShownOnTable.find(e=>e.id===t):null;if("outgoing"!==(null===(a=e.session)||void 0===a?void 0:a.direction)||"Not Found"!==e.cause&&"Canceled"!==e.cause||this._agentStatusService.updateAgentStatus({agent_status:i?i.ready_status:g,web_phone_status:"Registered",current_contact:null}),"incoming"===e.session.direction&&this.incomingSession&&this.incomingSession.id===e.session.id&&(this.incomingSession=null),!this.activeSession){this._webPhoneWindowService.changeSelectedWindow("dial-pad");break}this.activeSession===e.session?(this.activeSession=null,this._webPhoneWindowService.changeSelectedWindow("dial-pad")):this.activeSession!==e.session&&this._webPhoneWindowService.changeSelectedWindow("current-call"),"User Denied Media Access"==e.cause&&this._snackBar.open("Call Failed: Please make sure you have a mic connected & your browser has mic access.","X",{duration:5e3,verticalPosition:"top",panelClass:"error"});break}case"newRTCSession.outbound":this._webPhoneWindowService.changeSelectedWindow("current-call"),this.previousCall=e.session,this.previousActiveNumber=P}}_showPostCallWrapUp(e,t,i,n){const s=this._agentPostCallService.postCallWrapUpCalls.findIndex(t=>t.sessionData.callUuid===e.session.data.callUuid);if(-1!==s&&this._agentPostCallService.postCallWrapUpCalls.splice(s,1),i||e.session.data.campaignId){const t=i||e.session.data.campaignId,n=this._agentCampaignService.campaignsShownOnTable.find(e=>e.id===t);n&&this._agentPostCallService.addQuickSelectionCall({uuid:e.session.data.callUuid,phoneNumber:e.session.data.phoneNumber,forcePostCall:n.force_post_call,sessionData:e.session.data})}else if(n){const i=this._agentQueueService.queuesShownOnTable.find(e=>e.id===n);t&&t.length>4&&!t.startsWith("*")&&!t.startsWith("#")&&this._agentPostCallService.addQuickSelectionCall({uuid:e.session.data.callUuid,phoneNumber:e.session.data.phoneNumber,forcePostCall:!!i&&i.force_post_call,sessionData:e.session.data})}else{if(this._agentStatusService.agentStatusSubject.value&&this._agentStatusService.agentStatusSubject.value.campaign&&this._agentContactService.campaignContactSubject.value&&-1!==this._agentContactService.campaignContactSubject.value._phone_numbers.findIndex(e=>e.phone_number===t)){const i=this._agentStatusService.agentStatusSubject.value.campaign,n=this._agentCampaignService.campaignsShownOnTable.find(e=>e.id===i);t.length>4&&!t.startsWith("*")&&!t.startsWith("#")&&this._agentPostCallService.addQuickSelectionCall({uuid:e.session.data.callUuid,phoneNumber:e.session.data.phoneNumber,forcePostCall:!!n&&n.force_post_call,sessionData:e.session.data})}t&&t.length>4&&!t.startsWith("*")&&!t.startsWith("#")&&this._agentPostCallService.addQuickSelectionCall({uuid:e.session.data.callUuid,phoneNumber:e.session.data.phoneNumber,forcePostCall:!1,sessionData:e.session.data})}}_playCallConnectedTone(){this.callConnectedAudio.src="/assets/audio/campaigns/confbridge-join.wav",this.callConnectedAudio.crossOrigin="anonymous",this.callConnectedAudio.load(),this._userPreferenceService.userPreferenceSubject.value&&(this.callConnectedAudio.volume=this._userPreferenceService.userPreferenceSubject.value.agent_ringtone_volume),this.callConnectedAudio.play().catch(e=>{console.log(e)})}_playCallDisconnectedTone(){var e,t;this.callDisconnectedAudio.src="/assets/audio/phone/call-disconnected-tone.mp3",this.callDisconnectedAudio.crossOrigin="anonymous",this.callDisconnectedAudio.load(),this._userPreferenceService.userPreferenceSubject.value&&(this.callDisconnectedAudio.volume=(null===(e=this._userPreferenceService.userPreferenceSubject.value)||void 0===e?void 0:e.call_disconnected_tone_volume)?null===(t=this._userPreferenceService.userPreferenceSubject.value)||void 0===t?void 0:t.call_disconnected_tone_volume:"0.7"),this.callDisconnectedAudio.play().catch(e=>{console.log(e)})}removeSessionOnHold(e){let t=this.onHold.findIndex(t=>t.id==e.id);t>-1&&this.onHold.splice(t,1)}startSessionTimer(e){e.data.timer={time:this.formatTimer(0),interval:Object(s.a)(0,1e3)},e.data.timer.subscriber=e.data.timer.interval.subscribe(t=>{e.data.timer.time=this.formatTimer(t)})}stopSessionTimer(e){e.data.timer&&e.data.timer.subscriber&&e.data.timer.subscriber.unsubscribe()}}return e.\u0275fac=function(t){return new(t||e)(k.nc(v.a),k.nc(U.a),k.nc(X.b),k.nc(a.a),k.nc(c.a),k.nc(o.a),k.nc(r.a),k.nc(u.a),k.nc(l.a),k.nc(h.a),k.nc(d.a),k.nc(g.a),k.nc(S.a),k.nc(p.a),k.nc(I.a),k.nc(B.a),k.nc(y.a),k.nc(A.a),k.nc(P.a),k.nc(T.a),k.nc(j),k.nc(x.a),k.nc(q.a),k.nc(O.a))},e.\u0275prov=k.Xb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})()},CZaT:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var n=i("SqhC"),s=i("fXoL");let a=(()=>{class e{constructor(e){this.agentStatusService=e,this.overlayTitle="Web Phone Disconnected",this.buttonText="Reconnect",this._showOverlay=!1}get showOverlay(){return this._showOverlay}set showOverlay(e){this._showOverlay=e}hideOverlay(){this.showOverlay=!1}setReady(){this.buttonText="Reconnecting...",this.agentStatusService.updateAgentStatus({ready:!0}),setTimeout(()=>{this.hideOverlay(),this.buttonText="Reconnect"},500)}}return e.\u0275fac=function(t){return new(t||e)(s.nc(n.a))},e.\u0275prov=s.Xb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})()},FtZ2:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var n=i("fXoL"),s=i("tk/3");let a=(()=>{class e{constructor(e){this.http=e}list(e,t,i){let n=`?page=${t}&page_size=${e}`;return Object.keys(i).forEach(e=>{i[e]&&"duration_range_start"!==e&&"duration_range_end"!==e&&(n+=`&${e}=${i[e]}`)}),this.http.get("/api/livephonecalls/"+n)}getByUser(e){return this.http.get("/api/livephonecalls/?app_user_id="+e)}getByCallUuid(e){return this.http.get(`/api/livephonecalls/${e}/`)}hangUpTransfer(e){return this.http.get(`/api/livephonecalls/${e}/hanguptransfer/`)}}return e.\u0275fac=function(t){return new(t||e)(n.nc(s.b))},e.\u0275prov=n.Xb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})()},IbGr:function(e,t,i){"use strict";i.d(t,"a",(function(){return l}));var n=i("XNiG"),s=i("FrFE"),a=i("N/25"),c=i("fXoL"),o=i("tk/3");let r=(()=>{class e{constructor(e){this.http=e}create(e){return this.http.post("/api/myqueueagents/",e)}delete(e){return this.http.delete(`/api/myqueueagents/${e}/`)}get(){return this.http.get("/api/myqueueagents/")}update(e,t){return this.http.patch(`/api/myqueueagents/${e}/`,t)}}return e.\u0275fac=function(t){return new(t||e)(c.nc(o.b))},e.\u0275prov=c.Xb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})();var u=i("dNgK");let l=(()=>{class e{constructor(e,t,i,s){this.snackBar=e,this.queueService=t,this.authService=i,this.myQueueAgentService=s,this.queueAgents=[],this.queueAgentsUpdatedSubject=new n.a,this.allQueues=[],this.queuesShownOnTable=[],this.queueMap=[],this.queuesUpdatedSubject=new n.a,this.loading=!1,this.hiddenPauseNotifications=[],this.queueAgentPausedNotification=null,this.agentId=this.authService.getUserId()}handleQueueDeleteThunderpush(e){const t=this.allQueues.findIndex(t=>t.id===e),i=this.queuesShownOnTable.findIndex(t=>t.id===e);-1!==t&&this.allQueues.splice(t,1),-1!==i&&this.queuesShownOnTable.splice(i,1),delete this.queueMap[e],this.queuesUpdatedSubject.next(!0)}handleQueueStatusThunderpush(e){const t=this.allQueues.findIndex(t=>t.id===e.queue),i=this.queuesShownOnTable.findIndex(t=>t.id===e.queue);-1!==i?(-1===e.member_agents.findIndex(e=>e===this.authService.getUserId())?this.queuesShownOnTable.splice(i,1):(this.queuesShownOnTable[i].logged_in_agents=e.logged_in_agents,this.queuesShownOnTable[i].member_agents=e.member_agents),this.queuesUpdatedSubject.next(!0)):-1===i&&-1!==t&&this.queueMap[e.queue]&&(this._addQueueIfMember(this.queueMap[e.queue]),this.queuesUpdatedSubject.next(!0))}handleQueueThunderpush(e){const t=this.queuesShownOnTable.findIndex(t=>t.id===e.id);-1===t?-1===this.allQueues.findIndex(t=>t.id===e.id)?(this.allQueues.push(e),this.queueMap[e.id]=e,this._addQueueIfMember(e),this.queuesUpdatedSubject.next(!0)):e.member_agents.find(e=>e===this.agentId)&&(this.queuesShownOnTable.push(e),this.queuesUpdatedSubject.next(!0)):(this.queuesShownOnTable[t]=e,this.queueMap[t]=e,this.queuesUpdatedSubject.next(!0)),this.queueAgentsUpdatedSubject.next()}getQueues(){this.loading=!0,this.queuesShownOnTable=[],this.allQueues=[],this.queueService.list("max").subscribe({next:e=>{this.allQueues=e.results,e.results.forEach(e=>{this._addQueueIfMember(e)}),this.getQueueAgents(),this.loading=!1}})}getQueueAgents(){this.queueAgents=[],this.myQueueAgentService.get().subscribe({next:e=>{this.queueAgents=e.results}})}removePausedNotification(){this.queueAgentPausedNotification=null}handleQueueAgentPausedThunderpush(){this.myQueueAgentService.get().subscribe({next:e=>{e.results.forEach(e=>{e.paused&&(this.queueAgentPausedNotification=e)})}})}createQueueAgent(e){this.myQueueAgentService.create({app_user:this.agentId,queue:e}).subscribe({next:e=>{this.queueAgents.push(e),this.queueAgentsUpdatedSubject.next(),this.snackBar.open("Joined Queue","X",{duration:2500,verticalPosition:"top",panelClass:["success"]})}})}deleteQueueAgent(e){const t=this.queueAgents.findIndex(t=>t.queue===e);this.myQueueAgentService.delete(this.queueAgents[t].id).subscribe({next:()=>{this.queueAgentsUpdatedSubject.next(),this.snackBar.open("Exited Queue","X",{duration:2500,verticalPosition:"top",panelClass:["success"]})}}),this._removeQueueFromHiddenNotifications(e)}hidePausedNotification(e){this.hiddenPauseNotifications.push(e)}isAgentInQueue(e){return this.queueAgents.some(t=>t.queue==e)}isAgentStaticMember(e){const t=this.queueAgents.find(t=>t.queue==e);return!!t&&t.is_static}isQueueAgentPaused(e){const t=this.queueAgents.find(t=>t.queue==e);return!!t&&t.paused}unPauseQueueAgent(e){this.queueAgentBeingResumed=e;const t=this.queueAgents.findIndex(t=>t.queue==e);this.queueAgents[t].paused&&(this.myQueueAgentService.update(this.queueAgents[t].id,{paused:!1}).subscribe({next:e=>{this.queueAgents[t]=e,this.queueAgentBeingResumed=null,this.queueAgentsUpdatedSubject.next(),this.snackBar.open("Queue has been successfully resumed","X",{duration:3e3,verticalPosition:"top",panelClass:"success"})}}),this.queueAgentPausedNotification&&this.removePausedNotification())}_removeQueueFromHiddenNotifications(e){const t=this.hiddenPauseNotifications.findIndex(t=>t===e);-1!==t&&this.hiddenPauseNotifications.splice(t,1)}_addQueueIfMember(e){e.member_agents.find(e=>e===this.agentId)&&this.queuesShownOnTable.push(e),this.queueMap[e.id]=e,this.queuesUpdatedSubject.next(!0)}}return e.\u0275fac=function(t){return new(t||e)(c.nc(u.a),c.nc(s.a),c.nc(a.a),c.nc(r))},e.\u0275prov=c.Xb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})()},LVKg:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var n=i("fXoL"),s=i("tk/3");let a=(()=>{class e{constructor(e){this.http=e}filter(e,t,i){let n=`?ordering=-pk&page=${t}&page_size=${e}`;return Object.keys(i).forEach(e=>{if(null!==i[e]&&!1!==i[e])if("start"===e){if(null!==i[e][0]&&null!==i[e][1]){if(JSON.stringify(i[e][0])===JSON.stringify(i[e][1])){const t=i[e][0]?i[e][0].toISOString().split("T")[0]:"";n+=`&${e}__date=${t}`}else if(i[e]&&i[e][1]&&i[e][0]){let t=encodeURIComponent(i[e][1].toISOString().split(".")[0]).replace("T","%20");const s=encodeURIComponent(i[e][0].toISOString().split(".")[0]).replace("T","%20");n+=`&${e}__range_before=${t}&${e}__range_after=${s}`}}else if(i[e][1]){let t=encodeURIComponent(i[e][1].toISOString().split(".")[0]).replace("T","%20");n+=`&${e}__range_before=${t}`}else if(i[e][0]){let t=encodeURIComponent(i[e][0].toISOString().split(".")[0]).replace("T","%20");n+=`&${e}__range_after=${t}`}}else n+="system_disposition"===e?"abandoned-group"===i[e]?"&system_disposition__in="+["Answered Human Abandoned","Answered Machine Abandoned","Answered Notsure Abandoned","Answered Abandoned"]:"agent-connect-group"===i[e]?"&system_disposition__in="+["Answered Human","Answered Human Agentconnect","Answered Machine Agentconnect","Answered Notsure Agentconnect","Answered Agentconnect"]:"answered-machine-group"===i[e]?"&system_disposition__in="+["Answered Machine","Answered Notsure"]:"&"+e+"="+i[e]:"&"+e+"="+i[e]}),this.http.get("/api/myrecentcalls/"+n)}getWebPhoneCallHistory(){return this.http.get("/api/myrecentcalls/?page=1&page_size=15")}getLastCall(){return this.http.get("/api/myrecentcalls/?page=1&page_size=1")}}return e.\u0275fac=function(t){return new(t||e)(n.nc(s.b))},e.\u0275prov=n.Xb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})()},beuU:function(e,t,i){"use strict";i.d(t,"a",(function(){return S}));var n=i("2Vo4"),s=i("iwRK"),a=i("NkwR"),c=i("d0VH"),o=i("5Tly"),r=i("M4Aq"),u=i("+3se"),l=i("Z181"),h=i("LVVo"),d=i("/qv3"),g=i("tUwJ"),p=i("fXoL");let S=(()=>{class e{constructor(e,t,i,s,a,c,o,r,u,l){this._utils=e,this._agentUserService=t,this._agentNavService=i,this._agentScriptService=s,this._agentContactService=a,this._agentContactFieldService=c,this._userPreferenceService=o,this._agentAccountSettingService=r,this._personalizationService=u,this._dynamicAgentScriptManagerService=l,this.agentScriptIdSubject=new n.a(null),this.agentScriptSubject=new n.a(null),this.accountHasPersonalizationScripts=!1,this.agentScriptType=null,this.activeButtonId=null,this.agentDashboardContactSubscription=this._agentContactService.contactSubject.subscribe({next:e=>{e&&e.id&&this.accountHasPersonalizationScripts&&(this._agentNavService.activeDashboardSectionSubject.value&&"agent-script"===this._agentNavService.activeDashboardSectionSubject.value||this._userPreferenceService.userPreferenceSubject.value&&"agentScript"===this._userPreferenceService.userPreferenceSubject.value.agent_dash_lower_section)&&this.checkForPersonalizationScript(e.id)}})}ngOnDestroy(){this.agentDashboardContactSubscription&&this.agentDashboardContactSubscription.unsubscribe()}checkForPersonalizationScript(e){this._personalizationService.getByContact(e).subscribe({next:t=>{if(t.results&&t.results.length){this.contactPersonalizationId=e;const i=t.results[0].next_agent_script;i&&this.getAgentScript(i,!0)}}})}formatAgentScript(e){if(this.agentScriptSubject.value||e){if(this._agentContactService.contactSubject.value&&this._agentContactService.contactSubject.value.id&&!e&&this.recentContactId===this._agentContactService.contactSubject.value.id&&this.recentAgentScript===this.agentScriptSubject.value.id)return;const t=e||this.agentScriptSubject.value,i=t.script?"simple":"dynamic";if("dynamic"===i){const e=JSON.parse(JSON.stringify(this._agentContactService.contactSubject.value));this.dynamicScript=this._dynamicAgentScriptManagerService.formatDynamicScript(t.custom_settings.dynamic_script_config,e)}else if("simple"===i){const e=Object.assign(this._agentUserService.user?this._agentUserService.user.custom_settings:{},this._agentAccountSettingService.accountSettings?this._agentAccountSettingService.accountSettings.custom_settings:{}),i=JSON.parse(JSON.stringify(this._agentContactService.contactSubject.value));this.formattedScript=this._utils.formatAgentScript(t.script,e,i,this._agentContactFieldService.contactFieldSubject.value),this.recentAgentScript=this.agentScriptSubject.value.id,this._agentContactService.contactSubject.value&&(this.recentContactId=this._agentContactService.contactSubject.value.id)}}}getAgentScript(e,t){e&&(this.agentScriptSubject.value&&this.agentScriptSubject.value.id===e||this.lastAgentScriptId!==e&&(this.lastAgentScriptId=e,this._agentScriptService.get(e).subscribe({next:e=>{this.agentScriptType=e.script?"simple":"dynamic",t?this.formatAgentScript(e):(this.agentScriptSubject.next(e),this._agentContactService.contactSubject.value&&this.formatAgentScript())}})))}}return e.\u0275fac=function(t){return new(t||e)(p.nc(u.a),p.nc(o.a),p.nc(a.a),p.nc(s.a),p.nc(c.a),p.nc(h.a),p.nc(l.a),p.nc(r.a),p.nc(d.a),p.nc(g.a))},e.\u0275prov=p.Xb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})()},qqew:function(e,t,i){"use strict";i.d(t,"a",(function(){return l}));var n=i("FHnY"),s=i("N/25"),a=i("XNiG"),c=i("fXoL"),o=i("tk/3");let r=(()=>{class e{constructor(e){this.http=e}list(){return this.http.get("/api/mycampaignmemberships/?page_size=max")}}return e.\u0275fac=function(t){return new(t||e)(c.nc(o.b))},e.\u0275prov=c.Xb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})(),u=(()=>{class e{constructor(e){this.http=e}list(e){return this.http.get("/api/campaignleadcounts/?page_size=200&campaign_id__in="+e)}}return e.\u0275fac=function(t){return new(t||e)(c.nc(o.b))},e.\u0275prov=c.Xb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})(),l=(()=>{class e{constructor(e,t,i,n){this._authService=e,this._campaignService=t,this._myCampaignMembershipsService=i,this._campaignLeadCountService=n,this.campaignMap=[],this.allCampaigns=[],this.campaignIds=[],this.campaignsShownOnTable=[],this.outOfLeadCampaigns=[],this.campaignsUpdatedSubject=new a.a,this.loading=!1,this.campaignMemberAgents=[],this.agentId=this._authService.getUserId()}handleCampaignDeleteThunderpush(e){const t=this.allCampaigns.findIndex(t=>t.id===e),i=this.campaignsShownOnTable.findIndex(t=>t.id===e);-1!==t&&this.allCampaigns.splice(t,1),-1!==i&&this.campaignsShownOnTable.splice(i,1),delete this.campaignMap[e],this.campaignsUpdatedSubject.next(!0)}handleCampaignThunderpush(e){const t=this.campaignsShownOnTable.findIndex(t=>t.id===e.id);-1===t?-1===this.allCampaigns.findIndex(t=>t.id===e.id)?(this.allCampaigns.push(e),this._addCampaignIfMember(e)):this._addCampaignIfMember(e):(this.campaignsShownOnTable[t]=e,this.campaignMap[t]=e,this.campaignsUpdatedSubject.next(!0))}getCampaignById(e){this._campaignService.get(e).subscribe({next:e=>{this.campaignMap[e.id]=e}})}getCampaigns(){this.loading=!0,this.campaignsShownOnTable=[],this.allCampaigns=[],this.campaignIds=[],this._myCampaignMembershipsService.list().subscribe({next:e=>{this.campaignMemberAgents=e.results;const t=this.campaignMemberAgents.filter(e=>e.is_member).map(e=>e.id);t.length&&this._campaignService.getByIds(t).subscribe({next:e=>{this.allCampaigns=e.results,this.allCampaigns.forEach(e=>{this._addCampaignIfMember(e)}),this._getCampaignStats()}}),this.loading=!1}})}_addCampaignIfMember(e){const t=this.campaignMemberAgents.find(t=>t.id===e.id);t&&e.active&&t.is_member&&(this.campaignsShownOnTable.push(e),this.campaignMap[e.id]=e),this.campaignsUpdatedSubject.next(!0)}_getCampaignStats(){this.campaignIds=this.campaignsShownOnTable.map(e=>e.id),this.campaignIds.length&&this._campaignLeadCountService.list(this.campaignIds).subscribe({next:e=>{e.results.forEach(e=>{const t=this.allCampaigns.findIndex(t=>t.id===e.id);-1!==t&&(this.allCampaigns[t].total_contact_count=e.total_contact_count)})}})}}return e.\u0275fac=function(t){return new(t||e)(c.nc(s.a),c.nc(n.a),c.nc(r),c.nc(u))},e.\u0275prov=c.Xb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})()},roal:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var n=i("fXoL"),s=i("tk/3");let a=(()=>{class e{constructor(e){this.http=e}get(){return this.http.get("/api/mywebphone/")}}return e.\u0275fac=function(t){return new(t||e)(n.nc(s.b))},e.\u0275prov=n.Xb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})()},tUwJ:function(e,t,i){"use strict";i.d(t,"a",(function(){return l}));var n=i("d0VH"),s=i("5Tly"),a=i("M4Aq"),c=i("LVVo"),o=i("+3se"),r=i("fXoL"),u=i("dNgK");let l=(()=>{class e{constructor(e,t,i,n,s,a){this._agentContactService=e,this._agentUserService=t,this._agentAccountSettingService=i,this._agentContactFieldService=n,this._snackBar=s,this._utils=a,this.timeline=[],this.activeButtonIds=new Set,this.flattenedData=null,this.savingContact=!1,this.fieldsAlreadySetToNull=new Set,this.fieldsChangedByUser=new Set}onContactFieldChanged(e){var t;if(!(null===(t=this.contact)||void 0===t?void 0:t.id))return void this._snackBar.open("No contact selected. Please save this contact before editing.","X",{duration:5e3,verticalPosition:"top",panelClass:"error"});this.fieldsChangedByUser.add(e);const i=this.contact[e];if(i===this._agentContactService.contactSubject.value[e]&&null!==i)return void this.formatDynamicScript(this.script,this.contact);const n={[e]:this.contact[e]};this.savingContact=!0;const s=this._agentContactFieldService.contactFieldNameMap[e];s&&"Date"===s.data_type&&(n[e]=n[e].toISOString().split("T")[0]),this._agentContactService.updateContact(this.contact.id,n,!0,()=>{this.savingContact=!1})}processScript(e,t){this.timeline=[],this.flattenedData=e,this.contact=this._createContactClone(t);const i=Object.assign(this._agentUserService.user?this._agentUserService.user.custom_settings:{},this._agentAccountSettingService.accountSettings?this._agentAccountSettingService.accountSettings.custom_settings:{}),n=JSON.parse(JSON.stringify(this._agentContactService.contactSubject.value)),s=this._agentContactFieldService.contactFieldSubject.value;return Object.values(this.flattenedData.nodes).forEach(e=>{"agent_script"===e.type&&(e.body=this._utils.formatAgentScript(e.body,i,n,s))}),this.addNodeToTimeline(e.root),this.activeButtonIds.forEach(e=>{var t;const i=null===(t=this.flattenedData)||void 0===t?void 0:t.nodes[e];i&&this.timeline.some(t=>t.id===e)&&this.processButtonChildren(i)}),this.timeline}formatDynamicScript(e,t){var i;this.script=e,t&&t.id!==(null===(i=this.contact)||void 0===i?void 0:i.id)&&this.resetTimelineToRoot(),this.contact=t;const n=this.transformScriptData(this.script);return this.processScript(n,t)}resetTimelineToRoot(){this.timeline=[],this.flattenedData&&(this.timeline=[this.flattenedData.root],this.processChildNodes(this.flattenedData.root)),this.fieldsAlreadySetToNull.clear(),this.fieldsChangedByUser.clear(),this.contact&&(this.contact=this._createContactClone(this.contact)),this.activeButtonIds.clear(),this.savingContact=!1}isConditionMet(e){return!!this.contact&&e.every(e=>{const t=this.contact[e.value_left];return void 0!==t&&this.evaluateCondition(t,e.operator,e.value_right)})}isButtonClicked(e){return this.activeButtonIds.has(e)}onButtonClick(e){var t;if(this.activeButtonIds.has(e))return;const i=null===(t=this.flattenedData)||void 0===t?void 0:t.nodes[e],n=i?this.findParentNode(i):null;n&&this.deactivateSiblingButtons(n,e),this.activeButtonIds.add(e),i&&this.processButtonChildren(i)}_createContactClone(e){const t=JSON.parse(JSON.stringify(e));return this.flattenedData&&Object.values(this.flattenedData.nodes).forEach(i=>{var n;null===(n=i.contactFields)||void 0===n||n.forEach(i=>{i.showBlankValue&&!this.fieldsChangedByUser.has(i.name)?(t[i.name]=null,this.fieldsAlreadySetToNull.add(i.name)):this.fieldsChangedByUser.has(i.name)&&(t[i.name]=e[i.name])})}),t}deactivateSiblingButtons(e,t){var i;for(const n of e.childrenIds){const e=null===(i=this.flattenedData)||void 0===i?void 0:i.nodes[n];e&&"button"===e.type&&e.id!==t&&(this.activeButtonIds.delete(e.id),this.clearDescendantNodes(e.id))}}clearDescendantNodes(e){if(!e||!this.flattenedData)return;const t=this.flattenedData.nodes[e];t&&(this.timeline=this.timeline.filter(e=>!this.isDescendant(t,e)))}isDescendant(e,t){var i;if(e.childrenIds.includes(t.id))return!0;for(const n of e.childrenIds){const e=null===(i=this.flattenedData)||void 0===i?void 0:i.nodes[n];if(e&&this.isDescendant(e,t))return!0}return!1}processChildNodes(e){var t,i;if(!e.childrenIds||0===e.childrenIds.length)return;let n=!1;for(const s of e.childrenIds){const e=null===(t=this.flattenedData)||void 0===t?void 0:t.nodes[s];if("condition"===(null==e?void 0:e.type)&&this.isConditionMet(e.conditions||[])){n=!0,this.addNodeToTimeline(e),this.processChildNodes(e);break}}if(n){const t=e.childrenIds.map(e=>{var t;return null===(t=this.flattenedData)||void 0===t?void 0:t.nodes[e]}).find(e=>"condition"===(null==e?void 0:e.type)&&this.isConditionMet(e.conditions||[]));t&&t.childrenIds.forEach(e=>{var t;const i=null===(t=this.flattenedData)||void 0===t?void 0:t.nodes[e];i&&(this.addNodeToTimeline(i),"button"!==i.type&&this.processChildNodes(i))})}if(!n)for(const s of e.childrenIds){const e=null===(i=this.flattenedData)||void 0===i?void 0:i.nodes[s];e&&"condition"!==e.type&&(this.addNodeToTimeline(e),"button"!==e.type&&this.processChildNodes(e))}}addNodeToTimeline(e){this.timeline.some(t=>t.id===e.id)||(this.timeline.push(e),"button"!==e.type&&this.processChildNodes(e))}processButtonChildren(e){e.childrenIds&&0!==e.childrenIds.length&&e.childrenIds.forEach(e=>{var t;const i=null===(t=this.flattenedData)||void 0===t?void 0:t.nodes[e];i&&(this.timeline.some(e=>e.id===i.id)||(this.timeline.push(i),"button"!==i.type&&this.processChildNodes(i)))})}evaluateCondition(e,t,i){const n="string"==typeof e?e.toLowerCase():e,s="string"==typeof i?i.toLowerCase():i;switch(t){case"equals":return n===s;case"does not equal":return n!==s;case"greater than":return"number"==typeof n&&"number"==typeof s&&n>s;case"greater than or equal":return"number"==typeof n&&"number"==typeof s&&n>=s;case"less than":return"number"==typeof n&&"number"==typeof s&&n<s;case"less than or equal":return"number"==typeof n&&"number"==typeof s&&n<=s;case"is true":return 1==!!n;case"is false":return 0==!!n;case"after":return this._isAfterDate(n,s);case"before":return this._isBeforeDate(n,s);default:return!1}}_isAfterDate(e,t){const i=new Date(e),n=new Date(t);return isNaN(i.getTime())||isNaN(n.getTime())?(console.warn("Invalid date values provided for comparison"),!1):i>n}_isBeforeDate(e,t){const i=new Date(e),n=new Date(t);return isNaN(i.getTime())||isNaN(n.getTime())?(console.warn("Invalid date values provided for comparison"),!1):i<n}transformScriptData(e){const t={},i=this.flattenNode(e,t);return this.removeSiblingNodesAfterCondition(t),{root:i,nodes:t,contactFields:e.contactFields||[]}}flattenNode(e,t){const i={id:e.id,body:e.body,type:e.type,childrenIds:[],conditions:e.conditions||[],conditionType:e.conditionType||"",contactFields:e.contactFields||[]};return e.children&&e.children.length>0&&e.children.forEach(e=>{const n=this.flattenNode(e,t);i.childrenIds.push(n.id)}),t[e.id]=i,i}removeSiblingNodesAfterCondition(e){for(const t in e){const i=e[t];if("condition"===i.type&&this.isConditionMet(i.conditions||[])){const e=this.findParentNode(i);e&&(e.childrenIds=e.childrenIds.filter(e=>e===i.id))}}}findParentNode(e){if(!this.flattenedData)return null;for(const t in this.flattenedData.nodes){const i=this.flattenedData.nodes[t];if(i.childrenIds.includes(e.id))return i}return null}}return e.\u0275fac=function(t){return new(t||e)(r.nc(n.a),r.nc(s.a),r.nc(a.a),r.nc(c.a),r.nc(u.a),r.nc(o.a))},e.\u0275prov=r.Xb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})()},w0BY:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var n=i("XNiG"),s=i("fXoL");let a=(()=>{class e{constructor(){this.selectedWindow="dial-pad",this.selectedWindowSubject=new n.a,this.selectedWindowSubject.subscribe(e=>{this.selectedWindow=e})}changeSelectedWindow(e){this.selectedWindowSubject.next(e)}}return e.\u0275fac=function(t){return new(t||e)},e.\u0275prov=s.Xb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})()},xyEW:function(e,t,i){"use strict";i.d(t,"a",(function(){return c}));var n=i("2Vo4"),s=i("d0VH"),a=i("fXoL");let c=(()=>{class e{constructor(e){this._agentContactService=e,this.isHotLead=new n.a(null),this.hotBucketLeads=[],this.contactSubscription=this._agentContactService.contactSubject.subscribe({next:e=>{if(this.isHotLead.next(null),e&&e.id)if(e._hot_lead_bucket_id)this._isInHotBucketLeads(e.id)||this.hotBucketLeads.push({contactId:e.id,hotLeadBucketId:e._hot_lead_bucket_id,hotLeadBucketName:e._hot_lead_bucket_name}),this.isHotLead.next(e);else if(this._isInHotBucketLeads(e.id)){const t=this.hotBucketLeads.findIndex(t=>t.contactId===e.id),i=this.hotBucketLeads[t];e._hot_lead_bucket_id=i.hotLeadBucketId,e._hot_lead_bucket_name=i.hotLeadBucketName,this.isHotLead.next(e)}else this.hotBucketLeads=[]}})}ngOnDestroy(){this.contactSubscription.unsubscribe()}removeHotLead(e){const t=this.hotBucketLeads.findIndex(t=>t.contactId===e);-1!==t&&(this.hotBucketLeads.splice(t,1),this.isHotLead.value&&this.isHotLead.value.id===e&&this.isHotLead.next(null))}_isInHotBucketLeads(e){return this.hotBucketLeads.some(t=>t.contactId===e)}}return e.\u0275fac=function(t){return new(t||e)(a.nc(s.a))},e.\u0275prov=a.Xb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})()}}]);